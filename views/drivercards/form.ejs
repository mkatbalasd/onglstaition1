<div class="card card-form">
<form id="cardForm" method="POST" action="<%= card ? '/nagl/driver-cards/' + card.ID : '/nagl/driver-cards' %>">
  <h5 class="mb-3">معلومات البطاقة</h5>

  <div class="mb-3">
    <label class="form-label">نوع البطاقة</label>
    <input type="text" name="CardType" class="border rounded p-2 w-full" value="<%= card ? card.CardType : '' %>">
    <span class="error-message"></span>
  </div>

  <div class="mb-3">
    <label class="form-label">المنشأة</label>
    <div class="flex gap-2">
      <select name="FacilityID" class="border rounded p-2 w-full" <%= lockFacility ? 'disabled' : '' %>>
        <% facilities.forEach(f => { %>
          <option value="<%= f.FacilityID %>" <%= (card && card.FacilityID === f.FacilityID) || (facility && facility.FacilityID === f.FacilityID) ? 'selected' : '' %>><%= f.Name %> - <%= f.IdentityNumber %> - <%= f.LicenseType || '' %></option>
        <% }) %>
      </select>
      <span class="error-message"></span>
      <% if (!lockFacility) { %>
      <a href="/nagl/facilities/new" target="_blank" id="addFacilityBtn" class="px-3 py-1 border rounded text-gray-700"><i class="bi bi-plus"></i></a>
      <% } %>
      <% if (lockFacility) { %><input type="hidden" name="FacilityID" value="<%= facility.FacilityID %>"><% } %>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">السائق</label>
    <div class="flex gap-2">
      <select name="DriverID" class="border rounded p-2 w-full" <%= lockDriver ? 'disabled' : '' %>>
        <% drivers.forEach(d => { %>
          <option value="<%= d.DriverID %>" <%= (card && card.DriverID === d.DriverID) || (driver && driver.DriverID === d.DriverID) ? 'selected' : '' %>><%= d.FirstName %> <%= d.LastName %> - <%= d.IdentityNumber || '' %></option>
        <% }) %>
      </select>
      <span class="error-message"></span>
      <% if (!lockDriver) { %>
      <a href="#" target="_blank" id="addDriverBtn" class="px-3 py-1 border rounded text-gray-700"><i class="bi bi-plus"></i></a>
      <% } %>
      <% if (lockDriver) { %><input type="hidden" name="DriverID" value="<%= driver.DriverID %>"><% } %>
    </div>
  </div>

  <h5 class="mt-4 mb-3">التواريخ والمورد</h5>

  <div class="mb-3">
    <label class="form-label">تاريخ الإصدار</label>
    <input type="text" name="IssueDate" class="border rounded p-2 w-full hijri-date" value="<%= card ? card.IssueDate : '' %>">
    <span class="error-message"></span>
  </div>
  <div class="mb-3">
    <label class="form-label">تاريخ الانتهاء</label>
    <input type="text" name="ExpirationDate" class="border rounded p-2 w-full hijri-date" value="<%= card ? card.ExpirationDate : '' %>">
    <span class="error-message"></span>
  </div>
  <div class="mb-3">
    <label class="form-label">المورد</label>
    <select name="Supplier" class="border rounded p-2 w-full">
      <% suppliers.forEach(s => { %>
        <option value="<%= s.id %>" <%= card && card.Supplier === s.id ? 'selected' : '' %>><%= s.name %></option>
      <% }) %>
    </select>
  </div>

  <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">حفظ</button>
</form>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('cardForm');
  form.addEventListener('submit', e => {
    let valid = true;
    const fields = ['CardType', 'FacilityID', 'DriverID', 'IssueDate', 'ExpirationDate'];
    fields.forEach(name => {
      const input = form.elements[name];
      const error = input.parentElement.querySelector('.error-message');
      if (error) error.textContent = '';
      if (input && !input.disabled && !input.value.trim()) {
        if (error) error.textContent = 'هذا الحقل مطلوب';
        valid = false;
      }
    });
    if (!valid) e.preventDefault();
  });
});
</script>
